name: Build and Release

on:
  push:
    branches:
      - live
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: true
        default: 'true'
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  RUST_VERSION: 'stable'
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            rust_target: x86_64-pc-windows-msvc
            dotnet_rid: win-x64
            python_arch: x64
            setup_suffix: ""
          - arch: x86
            rust_target: i686-pc-windows-msvc
            dotnet_rid: win-x86
            python_arch: x86
            setup_suffix: "-x86"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: live
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Setup Python (${{ matrix.python_arch }})
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.python_arch }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            msd-calculator/target/
            msd-calculator-505/target/
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-${{ hashFiles('msd-calculator/Cargo.lock', 'msd-calculator-505/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore .NET dependencies
        run: dotnet restore OsuMappingHelper/OsuMappingHelper.csproj

      - name: Download previous release for delta generation (${{ matrix.arch }})
        id: prev_release
        shell: pwsh
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create architecture-specific Releases directory
          $arch = "${{ matrix.arch }}"
          $releasesDir = "Releases/$arch"
          New-Item -ItemType Directory -Path $releasesDir -Force | Out-Null
          
          # Determine package name pattern based on architecture
          $packagePattern = if ($arch -eq "x64") { "Companella-*" } else { "Companella-x86-*" }
          $releasesPattern = if ($arch -eq "x64") { "RELEASES-x64" } else { "RELEASES-x86" }
          
          # Try to download previous release files for delta generation
          try {
            $releases = gh release list --limit 1 --json tagName | ConvertFrom-Json
            if ($releases -and $releases.Count -gt 0) {
              $latestTag = $releases[0].tagName
              echo "Found previous release: $latestTag"
              
              # Download RELEASES file for delta generation (architecture-specific)
              echo "Downloading RELEASES file for $arch..."
              $result = gh release download $latestTag --pattern $releasesPattern --dir $releasesDir --clobber 2>&1
              # Rename to RELEASES if downloaded with arch suffix
              $downloadedReleases = Join-Path $releasesDir $releasesPattern
              $targetReleases = Join-Path $releasesDir "RELEASES"
              if (Test-Path $downloadedReleases) {
                Move-Item $downloadedReleases $targetReleases -Force
                echo "Downloaded and renamed RELEASES file for $arch"
              }
              
              # Download full nupkg for delta generation
              echo "Downloading full nupkg for $arch..."
              $result = gh release download $latestTag --pattern "$packagePattern-full.nupkg" --dir $releasesDir --clobber 2>&1
              $nupkgFiles = Get-ChildItem $releasesDir -Filter "*-full.nupkg" -ErrorAction SilentlyContinue
              if ($nupkgFiles) {
                echo "Downloaded: $($nupkgFiles.Name -join ', ')"
                echo "PREV_RELEASE_FOUND=true" >> $env:GITHUB_OUTPUT
              } else {
                echo "No full nupkg files found for $arch"
                echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
              }
              
              # List downloaded files
              echo "=== Downloaded files for delta generation ($arch) ==="
              Get-ChildItem $releasesDir -ErrorAction SilentlyContinue | ForEach-Object {
                echo "  $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
              }
            } else {
              echo "No previous releases found"
              echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            echo "Error fetching previous release: $_"
            echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
          }

      - name: Run build script (${{ matrix.arch }})
        shell: pwsh
        run: |
          ./build.ps1 -Configuration Release -Architecture ${{ matrix.arch }}

      - name: Read version (after build increment)
        id: version
        shell: pwsh
        run: |
          $version = Get-Content "OsuMappingHelper/version.txt" -Raw
          $version = $version.Trim()
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          # Convert to semver for Squirrel (v5.60 -> 5.60.0)
          $semver = $version -replace '^v', ''
          if ($semver -notmatch '^\d+\.\d+\.\d+') {
            if ($semver -match '^\d+\.\d+$') {
              $semver = "$semver.0"
            }
          }
          echo "SEMVER=$semver" >> $env:GITHUB_OUTPUT
          echo "Version: $version (semver: $semver)"

      - name: List release artifacts (${{ matrix.arch }})
        shell: pwsh
        run: |
          echo "=== Release Artifacts (${{ matrix.arch }}) ==="
          Get-ChildItem -Path "Releases" -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "" } else { "($([math]::Round($_.Length / 1MB, 2)) MB)" }
            echo "$($_.FullName) $size"
          }

      - name: Upload build artifacts (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.arch }}-${{ steps.version.outputs.VERSION }}
          path: Releases/${{ matrix.arch }}/
          retention-days: 30

      - name: Output version for release job
        id: output_version
        shell: pwsh
        run: |
          echo "VERSION=${{ steps.version.outputs.VERSION }}" >> $env:GITHUB_OUTPUT
          echo "SEMVER=${{ steps.version.outputs.SEMVER }}" >> $env:GITHUB_OUTPUT

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      semver: ${{ steps.version.outputs.SEMVER }}

  release:
    needs: build
    runs-on: windows-latest
    if: github.ref == 'refs/heads/live' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: live
          fetch-depth: 0

      - name: Download x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-x64-${{ needs.build.outputs.version }}
          path: Releases/x64/

      - name: Download x86 artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-x86-${{ needs.build.outputs.version }}
          path: Releases/x86/

      - name: Rename RELEASES files with architecture suffix
        shell: pwsh
        run: |
          # Rename RELEASES files to include architecture suffix for upload
          if (Test-Path "Releases/x64/RELEASES") {
            Copy-Item "Releases/x64/RELEASES" "Releases/x64/RELEASES-x64"
          }
          if (Test-Path "Releases/x86/RELEASES") {
            Copy-Item "Releases/x86/RELEASES" "Releases/x86/RELEASES-x86"
          }

      - name: List all release artifacts
        shell: pwsh
        run: |
          echo "=== All Release Artifacts ==="
          Get-ChildItem -Path "Releases" -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "" } else { "($([math]::Round($_.Length / 1MB, 2)) MB)" }
            echo "$($_.FullName) $size"
          }

      - name: Create version tag
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.build.outputs.version }}"
          echo "Creating tag: $version"
          
          # Check if tag already exists
          $existingTag = git tag -l $version
          if ($existingTag) {
            echo "Tag $version already exists, skipping creation"
          } else {
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a $version -m "Release $version"
            git push origin $version
            echo "Tag $version created and pushed"
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: Companella! ${{ needs.build.outputs.version }}
          body: |
            ## Companella! ${{ needs.build.outputs.version }}
            
            ### Installation
            
            **64-bit Windows (Recommended):**
            - Download and run `CompanellaSetup.exe`
            
            **32-bit Windows:**
            - Download and run `CompanellaSetup-x86.exe`
            
            **Existing Users:** The app will auto-update, or download the latest Setup executable for your architecture.
            
            ### Files
            
            **64-bit (x64):**
            - `CompanellaSetup.exe` - Installer for 64-bit Windows
            - `Companella-${{ needs.build.outputs.semver }}-full.nupkg` - Full update package (x64)
            - `RELEASES-x64` - Release manifest for auto-updater (x64)
            
            **32-bit (x86):**
            - `CompanellaSetup-x86.exe` - Installer for 32-bit Windows
            - `Companella-x86-${{ needs.build.outputs.semver }}-full.nupkg` - Full update package (x86)
            - `RELEASES-x86` - Release manifest for auto-updater (x86)
          files: |
            Releases/x64/CompanellaSetup.exe
            Releases/x64/RELEASES-x64
            Releases/x64/Companella-${{ needs.build.outputs.semver }}-full.nupkg
            Releases/x64/Companella-${{ needs.build.outputs.semver }}-delta.nupkg
            Releases/x86/CompanellaSetup-x86.exe
            Releases/x86/RELEASES-x86
            Releases/x86/Companella-x86-${{ needs.build.outputs.semver }}-full.nupkg
            Releases/x86/Companella-x86-${{ needs.build.outputs.semver }}-delta.nupkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
